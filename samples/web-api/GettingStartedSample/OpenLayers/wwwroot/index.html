<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Getting started with map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="desktop.png">
    <meta name="apple-mobile-web-app-title" content="ThinkGeo Getting started" />
    <link href="Content/ol.css" rel="stylesheet" />
    <link href="Content/thinkgeo.openlayers.css" rel="stylesheet" />
    <link href="Content/Site.css" rel="stylesheet" />
</head>
<body>
    <div id="map-page">
        <div id="map">
            <div id="popup" class="ol-popup">
                <a href="#" id="popup-closer" class="ol-popup-closer"></a>
                <div id="popup-content"></div>
            </div>
            <div id="contextMenu" class="ol-menu">
                <a class="menu-item" href="#" onclick="centerHere();">Center map here</a>
                <div class="menu-separator"></div>
                <a class="menu-item" href="#" onclick="zoom(5);">Zoom to zoomlevel 5 (Country Level)</a>
                <a class="menu-item" href="#" onclick="zoom(8);">Zoom to zoomlevel 8 (State Level)</a>
                <a class="menu-item" href="#" onclick="zoom(12);">Zoom to zoomlevel 12 (City Level)</a>
                <a class="menu-item" href="#" onclick="zoom(17);">Zoom to zoomlevel 17 (Street Level)</a>
            </div>
        </div>
        <div id="tips">
            <ul>
                <li id="scale">Scale: 1:73,957,338</li>
                <li id="zoom">Zoom: 2</li>
                <li id="lat">Latitude: 37.80014 </li>
                <li id="lng">Longitude: -96.1010</li>
            </ul>
        </div>
        <div id="locateError"></div>
    </div>
    <script src="Scripts/jquery-1.11.1.min.js"></script>
    <script src="Scripts/ol.js"></script>
    <script src="Scripts/thinkgeo.openlayers.js"></script>
    <script>
        // Create the openlayers map.
        var map = new ol.Map({
            controls: [
                new ol.control.Zoom(),
                new ol.control.Attribution({
                    collapsible: false
                })
            ],
            layers: [
                new ol.mapsuite.VectorTileLayer('https://cdn.thinkgeo.com/worldstreets-styles/4.0.0/light.json', {
                    apiKey: 'PIbGd76RyHKod99KptWTeb-Jg9JUPEPUBFD3SZJYLDE~',
                    layerName: 'light'
                })
            ],
            // set the default extent
            target: 'map',
            view: new ol.View({
                center: [-10777396.499651, 4821690.0604384],
                zoom: 4
            })
        });

        // Add image buttons for locate, full extent and help.
        var imgControls = new app.ImagesControl({
            imgs: [
                {
                    src: 'Images/location-inactive.png',
                    title: 'Locate',
                    callback: function () {
                        locate(this, 'location.png', 'location-inactive.png');
                    }
                },
                {
                    src: 'Images/full-extent.png',
                    title: 'Zoom to full extent',
                    callback: function () {
                        map.setView(new ol.View({ center: [-4.9158, -4.2187], zoom: 2 }));
                    }
                },
                {
                    src: 'Images/info.png',
                    title: 'Help',
                    callback: function () { window.open('http://wiki.thinkgeo.com/wiki/Map_Suite_WebAPI_Edition_Samples_Getting_Started', '_blank'); }
                }
            ]
        });
        map.addControl(imgControls);

        // Hook up the mouse-move event for showing current scale, zoomlevel and center point.
        map.on('moveend', function (e) {
            var mapView = this.getView();
            var zoom = mapView.getZoom();
            var scale = app.getScale(zoom);
            var center = ol.proj.transform(mapView.getCenter(), 'EPSG:3857', 'EPSG:4326');

            $('#scale').text('Scale: 1:' + Math.round(scale).toLocaleString());
            $('#zoom').text('Zoom: ' + zoom);
            $('#lat').text('Latitude: ' + center[0].toPrecision(6));
            $('#lng').text('Longitude: ' + center[1].toPrecision(6));
        });

        // Create the popup based on the HTML elements.
        var container = document.getElementById('popup');
        var content = document.getElementById('popup-content');
        var closer = document.getElementById('popup-closer');
        // Hook up a click event to the "close" div for hiding the popup.
        closer.onclick = function () {
            container.style.display = 'none';
            closer.blur();
            return false;
        };
        // Create an overlay to anchor the popup to the map.
        var overlay = new ol.Overlay({
            element: container
        });
        map.addOverlay(overlay);

        // Hook up the map.click event to show a popup with current latitude/longitude.
        map.on('click', function (e) {
            var coordinate = e.coordinate;
            var center = ol.proj.transform(coordinate, 'EPSG:3857', 'EPSG:4326');

            overlay.setPosition(coordinate);
            content.innerHTML = 'Latitude:' + center[1].toFixed(4) + '<br/>Longitude:' + center[0].toFixed(4);
            container.style.display = 'block';
        });

        // Add context-menu to the map
        var menuContainer = document.getElementById('contextMenu');
        var menuContent = document.getElementById('contextMenu-content');
        var menuOverlay = new ol.Overlay({
            element: menuContainer
        });
        map.addOverlay(menuOverlay);
        map.getViewport().oncontextmenu = function (e) {
            e.preventDefault();

            var offsetx = e.clientX + 50;
            var offsety = e.clientY + 150;
            var menuPoint = map.getCoordinateFromPixel([offsetx, offsety]);
            menuOverlay.setPosition(menuPoint);
            menuContainer.style.display = 'block';
        };
        map.on('click', function () {
            menuContainer.style.display = "none";
        });

        // Get Geolocation.
        var geolocation = new ol.Geolocation({
            projection: map.getView().getProjection(),
            tracking: false,
            trackingOptions: {
                maximumAge: 10000,
                enableHighAccuracy: true,
                timeout: 600000
            }
        });

        var source = new ol.source.Vector();
        var vector = new ol.layer.Vector({
            source: source,
            style: new ol.style.Style({
                fill: new ol.style.Fill({
                    color: 'rgba(19, 106, 236, .3)'
                }),
                stroke: new ol.style.Stroke({
                    color: '#136AEC',
                    width: 2
                }),
                image: new ol.style.Circle({
                    radius: 7,
                    fill: new ol.style.Fill({
                        color: '#2A93EE'
                    })
                })
            })
        });
        map.addLayer(vector);

        // Listen to position changes and show it on the map
        var accuracyFeature = new ol.Feature();
        var positionFeature = new ol.Feature();
        geolocation.on('change', function (evt) {
            var location = geolocation.getPosition();
            var accuracy = geolocation.getAccuracy();

            accuracyFeature = new ol.Feature(new ol.geom.Circle(location, accuracy));
            positionFeature = new ol.Feature(new ol.geom.Point(location));
            source.addFeatures([accuracyFeature, positionFeature]);

            map.getView().fitExtent(accuracyFeature.getGeometry().getExtent(), map.getSize());
        });
        geolocation.on('error', function (e) {
            $('#locateError').text('Failed to locate your position.');
        });

        // Change the style of "locate" icon on toolbar between active and deactive.
        locate = function (locateImg, activeImg, deactiveImg) {
            if ($(locateImg).hasClass('active')) {
                geolocation.setTracking(false);
                source.clear();

                locateImg.src = 'Images/' + deactiveImg;
                $(locateImg).removeClass('active');
            }
            else {
                geolocation.setTracking(true); // start position tracking

                locateImg.src = 'Images/' + activeImg;
                $(locateImg).addClass('active');
            }
        };

        var centerHere = function () {
            map.getView().setCenter(menuOverlay.getPosition());

            menuContainer.style.display = "none";
        };

        var zoom = function (zoomnum) {
            map.getView().setZoom(zoomnum);
            map.getView().setCenter(menuOverlay.getPosition());

            menuContainer.style.display = "none";
        };
    </script>
</body>
</html>
